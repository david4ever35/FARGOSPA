@page "/login"
@inject SpaDbContext Db
@inject FargoSpaAppWellness.Services.UserSession Session
@inject NavigationManager Nav

<h1>Login / Sign Up</h1>

<div class="mb-3">
    <label>Email</label>
    <input class="form-control" @bind="email" />
</div>

<div class="mb-3">
    <label>Password</label>
    <input type="password" class="form-control" @bind="password" />
</div>

<button class="btn btn-primary me-2" @onclick="HandleLogin">Login</button>
<button class="btn btn-secondary" @onclick="HandleRegister">Sign Up</button>

@if (!string.IsNullOrEmpty(error))
{
    <p class="text-danger mt-3">@error</p>
}

@code {
    string email = "";
    string password = "";
    string? error;

    void HandleLogin()
    {
        error = null;

        // Find existing user
        var user = Db.Users.FirstOrDefault(u => u.Email == email && u.Password == password);

        if (user == null)
        {
            error = "Invalid email or password.";
            return;
        }

        // Set session
        Session.Login(user);

        // Navigate home
        Nav.NavigateTo("/");
    }

    void HandleRegister()
    {
        error = null;

        if (Db.Users.Any(u => u.Email == email))
        {
            error = "User already exists.";
            return;
        }

        var user = new AppUser
        {
            Email = email,
            Password = password,
            Role = "User" // make everyone user by default
        };

        Db.Users.Add(user);
        Db.SaveChanges();

        Session.Login(user);
        Nav.NavigateTo("/");
    }
}
