@page "/testimonials"
@namespace FargoSpaAndWellness.Components.Pages
@using FargoSpaAndWellness.Models
@using System.ComponentModel.DataAnnotations
@using System.Collections.Generic
@using System.Threading.Tasks
@using System.Linq
@using System

<style>
    .full-width-table {
        width: 100%;
        border-collapse: collapse;
    }

    .table-container {
        padding: 0;
        margin: 0;
    }
</style>

@code {
    // Model for the form
    private Testimonial Review { get; set; } = new Testimonial();

    // In-memory list of reviews shown on the page
    private List<Testimonial> Reviews { get; set; } = new List<Testimonial>();

    // Simple local repository implementation to satisfy the existing calls to "Repository".
    // This keeps the page self-contained and fixes the missing symbol errors.
    private readonly SimpleRepository Repository = new SimpleRepository();

    protected override async Task OnInitializedAsync()
    {
        Reviews = await Repository.GetReviewsAsync();
    }

    public async Task ReviewAdded()
    {
        Reviews = await Repository.GetReviewsAsync();
    }

    // Submit handler - return Task so it matches OnValidSubmit's async delegate
    private async Task SubmitAsync()
    {
        await Repository.AddReviewAsync(new Testimonial
        {
            Name = Review.Name,
            Rating = Review.Rating,
            Remarks = Review.Remarks,
        });

        Review = new Testimonial(); // Reset form

        Reviews = await Repository.GetReviewsAsync();
    }

    private class SimpleRepository
    {
        private static readonly List<Testimonial> _store = new List<Testimonial>();
        private static int _nextId = 1;
        private static readonly object _lock = new object();

        public Task<List<Testimonial>> GetReviewsAsync()
        {
            // Return a shallow copy to avoid external mutation
            List<Testimonial> copy;
            lock (_lock)
            {
                copy = _store.Select(r => new Testimonial
                {
                    Id = r.Id,
                    Name = r.Name,
                    Rating = r.Rating,
                    Remarks = r.Remarks,
                    Date = r.Date
                }).ToList();
            }
            return Task.FromResult(copy);
        }

        public Task AddReviewAsync(Testimonial testimonial)
        {
            if (testimonial == null) throw new ArgumentNullException(nameof(testimonial));

            lock (_lock)
            {
                testimonial.Id = _nextId++;
                testimonial.Date = DateTime.UtcNow;
                // store a copy to avoid outside references
                _store.Add(new Testimonial
                {
                    Id = testimonial.Id,
                    Name = testimonial.Name,
                    Rating = testimonial.Rating,
                    Remarks = testimonial.Remarks,
                    Date = testimonial.Date
                });
            }

            return Task.CompletedTask;
        }
    }
}

<h3>Testimonials</h3>



<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Rating</th>
            <th>Remarks</th>
        </tr>
    </thead>
    <tbody>
        @foreach(var review in Reviews)
        {
          <tr>
              <td>@review.Name</td>
              <td>@review.Rating</td>
              <td>@review.Remarks</td>
          </tr>
        }
    </tbody>
</table>

<h4>Leave your review!</h4>
<EditForm Model="@Review" OnValidSubmit="@SubmitAsync" FormName="TestimonialForm">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <ul>
        <li>
            <label for="name">Name:</label>
            <InputText id="name" @bind-Value="Review.Name" />
        </li>
        <li>
            <label for="rating">Rating:</label>
            <InputNumber id="rating" @bind-Value="Review.Rating" min="1" max="5" />
        </li>
        <li>
            <label for="remarks">Remarks:</label>
            <InputText id="remarks" @bind-Value="Review.Remarks" +/>
        </li>
        <li>
            <button type="submit">Add Testimonial</button>
        </li>
    </ul>
</EditForm>
