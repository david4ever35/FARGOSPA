@page "/admin"

@using FargoSpaAppWellness.Models
@using FargoSpaAppWellness.Data


@inject FargoSpaAppWellness.Services.UserSession Session
@inject SpaDbContext Db
<style>
    .padded {
        padding: 20px;
    }
</style>
<div class="padded">
@if (!Session.IsAdmin)
{
    <RedirectToHome />
}
else
{
    <h1>Admin Dashboard</h1>

    <!-- ================= USERS ================= -->
    <h2 class="mt-4">Users</h2>

    @if (users.Count == 0)
    {
        <p>No users found.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var u in users)
                {
                    <tr>
                        <td>@u.Email</td>
                        <td>@u.Role</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-2"
                                    @onclick="() => ToggleRole(u)">
                                Toggle Role
                            </button>

                            <button class="btn btn-sm btn-danger"
                                    @onclick="() => DeleteUser(u.Id)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- ================= TESTIMONIALS ================= -->
    <h2 class="mt-5">Testimonials</h2>

    @if (testimonials.Count == 0)
    {
        <p>No testimonials found.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Message</th>
                    <th>Rating</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in testimonials)
                {
                    <tr>
                        <td>@t.Name</td>
                        <td>@t.Message</td>
                        <td>@t.Rating</td>
                        <td>
                            <button class="btn btn-sm btn-danger"
                                    @onclick="() => DeleteTestimonial(t.Id)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- ================= CREATE APPOINTMENT ================= -->
    <h2 class="mt-5">Create Appointment Slot</h2>

    <div class="row g-2 mb-3">
        <div class="col-md-3">
            <input class="form-control"
                   placeholder="Service Name"
                   @bind="newServiceName" />
        </div>

        <div class="col-md-3">
            <input type="datetime-local"
                   class="form-control"
                   @bind="newAppointmentDateTime" />
        </div>

        <div class="col-md-3">
            <input class="form-control"
                   placeholder="Provider Name"
                   @bind="newProviderName" />
        </div>

        <div class="col-md-3">
            <button class="btn btn-success w-100"
                    @onclick="CreateAppointment">
                Add Appointment
            </button>
        </div>
    </div>

    <!-- ================= APPOINTMENTS ================= -->
    <h2 class="mt-4">Appointments</h2>

    @if (appointments.Count == 0)
    {
        <p>No appointments created.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Date & Time</th>
                    <th>Provider</th>
                    <th>Status</th>
                    <th>Booked By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var a in appointments)
                {
                    <tr>
                        <td>@a.ServiceName</td>
                        <td>@a.AppointmentDateTime.ToString("g")</td>
                        <td>@a.ProviderName</td>
                        <td>@(a.IsBooked ? "Booked" : "Available")</td>
                        <td>@a.BookedByEmail</td>
                        <td>
                            <button class="btn btn-sm btn-danger"
                                    @onclick="() => DeleteAppointment(a.Id)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- CONTACT MESSAGES -->
    <h2 class="mt-5">Contact Messages</h2>

    @if (contactMessages.Count == 0)
    {
        <p>No contact messages.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Message</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in contactMessages)
                {
                    <tr>
                        <td>@c.Name</td>
                        <td>@c.Email</td>
                        <td>@c.Phone</td>
                        <td>@c.Message</td>
                        <td>@c.SubmittedAt.ToShortDateString()</td>
                        <td>
                            <button class="btn btn-sm btn-danger"
                                    @onclick="() => DeleteContact(c.Id)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

}
</div>
@code {
    // ================= DATA =================
    List<AppUser> users = new();
    List<Testimonial> testimonials = new();
    List<Appointment> appointments = new();
    List<ContactMessage> contactMessages = new();


    // ================= NEW APPOINTMENT FORM =================
    string newServiceName = "";
    string newProviderName = "";
    DateTime newAppointmentDateTime = DateTime.Now;

    protected override void OnInitialized()
    {
        if (Session.IsAdmin)
        {
            LoadAll();
        }
    }

    void LoadAll()
    {
        users = Db.Users.ToList();
        testimonials = Db.Testimonials.ToList();
        appointments = Db.Appointments
            .OrderBy(a => a.AppointmentDateTime)
            .ToList();
        contactMessages = Db.ContactMessages
            .OrderByDescending(c => c.SubmittedAt)
            .ToList();

    }

    // ================= USERS =================
    void DeleteUser(int id)
    {
        var user = Db.Users.Find(id);
        if (user != null)
        {
            Db.Users.Remove(user);
            Db.SaveChanges();
            users = Db.Users.ToList();
        }
    }

    void ToggleRole(AppUser user)
    {
        user.Role = user.Role == "Admin" ? "User" : "Admin";
        Db.SaveChanges();
        users = Db.Users.ToList();
    }

    // ================= TESTIMONIALS =================
    void DeleteTestimonial(int id)
    {
        var t = Db.Testimonials.Find(id);
        if (t != null)
        {
            Db.Testimonials.Remove(t);
            Db.SaveChanges();
            testimonials = Db.Testimonials.ToList();
        }
    }

    // ================= APPOINTMENTS =================
    void CreateAppointment()
    {
        if (string.IsNullOrWhiteSpace(newServiceName) ||
            string.IsNullOrWhiteSpace(newProviderName))
            return;

        var appointment = new Appointment
        {
            ServiceName = newServiceName,
            ProviderName = newProviderName,
            AppointmentDateTime = newAppointmentDateTime,
            IsBooked = false
        };

        Db.Appointments.Add(appointment);
        Db.SaveChanges();

        newServiceName = "";
        newProviderName = "";
        newAppointmentDateTime = DateTime.Now;

        appointments = Db.Appointments
            .OrderBy(a => a.AppointmentDateTime)
            .ToList();
    }

    void DeleteAppointment(int id)
    {
        var a = Db.Appointments.Find(id);
        if (a != null)
        {
            Db.Appointments.Remove(a);
            Db.SaveChanges();
            appointments = Db.Appointments.ToList();
        }
    }

    void DeleteContact(int id)
    {
        var entry = Db.ContactMessages.Find(id);
        if (entry != null)
        {
            Db.ContactMessages.Remove(entry);
            Db.SaveChanges();
            contactMessages = Db.ContactMessages.ToList();
        }
    }

}
